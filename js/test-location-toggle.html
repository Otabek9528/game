<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location Test - Muslim Vegukin Bot</title>
  <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
    }
    
    .status-box {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .status-item:last-child {
      border-bottom: none;
    }
    
    .status-label {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .status-value {
      font-weight: 600;
    }
    
    .status-value.yes {
      color: #4CAF50;
    }
    
    .status-value.no {
      color: #f44336;
    }
    
    button {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:active {
      transform: scale(0.98);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .location-data {
      background: rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      padding: 15px;
      margin-top: 20px;
      display: none;
    }
    
    .location-data.show {
      display: block;
    }
    
    .location-item {
      padding: 8px 0;
    }
    
    .instructions {
      background: rgba(255, 152, 0, 0.2);
      border-left: 4px solid #ff9800;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .instructions strong {
      color: #ff9800;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìç Geolocation Toggle Test</h1>
    
    <div class="instructions">
      <strong>To make the toggle appear:</strong><br>
      1. Click "Request Location" below<br>
      2. When prompted, click "Open Settings"<br>
      3. You'll see the Geolocation toggle appear!<br>
      4. Enable the toggle<br>
      5. Come back and click "Request Location" again - no prompt this time!
    </div>
    
    <div class="status-box">
      <h3 style="margin-bottom: 15px;">Location Manager Status</h3>
      <div class="status-item">
        <span class="status-label">Initialized:</span>
        <span class="status-value" id="statusInited">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">Location Available:</span>
        <span class="status-value" id="statusAvailable">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">Access Requested:</span>
        <span class="status-value" id="statusRequested">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">Access Granted:</span>
        <span class="status-value" id="statusGranted">-</span>
      </div>
    </div>
    
    <button class="btn-primary" id="btnRequest">üìç Request Location</button>
    <button class="btn-secondary" id="btnSettings">‚öôÔ∏è Open Settings</button>
    <button class="btn-secondary" id="btnRefresh">üîÑ Refresh Status</button>
    
    <div class="location-data" id="locationData">
      <h3 style="margin-bottom: 10px;">üìå Location Data</h3>
      <div class="location-item">
        <strong>Latitude:</strong> <span id="lat">-</span>
      </div>
      <div class="location-item">
        <strong>Longitude:</strong> <span id="lon">-</span>
      </div>
      <div class="location-item">
        <strong>Accuracy:</strong> <span id="accuracy">-</span>
      </div>
      <div class="location-item">
        <strong>Altitude:</strong> <span id="altitude">-</span>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.disableVerticalSwipes();

    const locationManager = tg.LocationManager;
    let isInitialized = false;

    // Update status display
    function updateStatus() {
      if (!locationManager) {
        alert('LocationManager not available. Please update Telegram to the latest version.');
        return;
      }

      document.getElementById('statusInited').textContent = locationManager.isInited ? 'Yes' : 'No';
      document.getElementById('statusInited').className = 'status-value ' + (locationManager.isInited ? 'yes' : 'no');
      
      document.getElementById('statusAvailable').textContent = locationManager.isLocationAvailable ? 'Yes' : 'No';
      document.getElementById('statusAvailable').className = 'status-value ' + (locationManager.isLocationAvailable ? 'yes' : 'no');
      
      document.getElementById('statusRequested').textContent = locationManager.isAccessRequested ? 'Yes' : 'No';
      document.getElementById('statusRequested').className = 'status-value ' + (locationManager.isAccessRequested ? 'yes' : 'no');
      
      document.getElementById('statusGranted').textContent = locationManager.isAccessGranted ? 'Yes' : 'No';
      document.getElementById('statusGranted').className = 'status-value ' + (locationManager.isAccessGranted ? 'yes' : 'no');

      console.log('Status updated:', {
        isInited: locationManager.isInited,
        isLocationAvailable: locationManager.isLocationAvailable,
        isAccessRequested: locationManager.isAccessRequested,
        isAccessGranted: locationManager.isAccessGranted
      });
    }

    // Initialize LocationManager
    function initLocationManager() {
      if (!locationManager) {
        alert('LocationManager not available in this Telegram version');
        return;
      }

      locationManager.init(() => {
        console.log('‚úÖ LocationManager initialized');
        isInitialized = true;
        updateStatus();

        // Listen for location manager updates
        tg.onEvent('locationManagerUpdated', () => {
          console.log('üìç Location Manager status changed');
          updateStatus();
          
          // If just granted access, immediately get location
          if (locationManager.isAccessGranted) {
            requestLocation();
          }
        });
      });
    }

    // Request location
    function requestLocation() {
      if (!isInitialized) {
        initLocationManager();
        setTimeout(requestLocation, 500);
        return;
      }

      console.log('üì° Requesting location...');
      
      locationManager.getLocation((location) => {
        if (location === null) {
          console.log('‚ùå Location request denied or failed');
          tg.showPopup({
            title: 'üìç Location Permission Needed',
            message: 'This app needs access to your location to find nearby mosques and determine Qibla direction.\n\nPlease tap "Open Settings" below to enable the Geolocation toggle.',
            buttons: [
              { id: 'settings', type: 'default', text: '‚öôÔ∏è Open Settings' },
              { id: 'cancel', type: 'cancel', text: 'Cancel' }
            ]
          }, (buttonId) => {
            if (buttonId === 'settings') {
              openSettings();
            }
          });
        } else {
          console.log('‚úÖ Got location:', location);
          displayLocation(location);
        }
      });
    }

    // Display location data
    function displayLocation(location) {
      document.getElementById('lat').textContent = location.latitude.toFixed(6);
      document.getElementById('lon').textContent = location.longitude.toFixed(6);
      document.getElementById('accuracy').textContent = location.horizontal_accuracy 
        ? location.horizontal_accuracy.toFixed(2) + ' m' 
        : 'N/A';
      document.getElementById('altitude').textContent = location.altitude 
        ? location.altitude.toFixed(2) + ' m' 
        : 'N/A';
      
      document.getElementById('locationData').classList.add('show');
      
      tg.showAlert('‚úÖ Location received successfully!');
    }

    // Open settings
    function openSettings() {
      console.log('‚öôÔ∏è Opening location settings...');
      if (locationManager && typeof locationManager.openSettings === 'function') {
        locationManager.openSettings();
      } else {
        tg.showAlert('Please enable location access in bot settings (three-dot menu ‚Üí Geolocation)');
      }
    }

    // Event listeners
    document.getElementById('btnRequest').addEventListener('click', requestLocation);
    document.getElementById('btnSettings').addEventListener('click', openSettings);
    document.getElementById('btnRefresh').addEventListener('click', updateStatus);

    // Auto-initialize on load
    if (locationManager) {
      initLocationManager();
    } else {
      alert('LocationManager not available. Update Telegram to latest version.');
    }
  </script>
</body>
</html>
