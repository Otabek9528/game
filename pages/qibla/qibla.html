<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Qibla Yo'nalishi</title>
  <link rel="stylesheet" href="../../css/style.css" />
  <link rel="stylesheet" href="qibla.css" />
</head>
<body>

  <!-- HEADER -->
  <header class="app__header">
    <a href="../../index.html" class="header-content" style="text-decoration: none; color: inherit;">
      <img src="../../assets/emblem.jpg" alt="Bot Emblem" class="bot-logo" />
      <h1>Muslim Vegukin Bot</h1>
    </a>
  </header>

  <!-- QIBLA CONTAINER -->
  <div class="qibla-container">
    
    <!-- Page Header -->
    <div class="qibla-header">
      <div class="header-decoration"></div>
      <h2 class="qibla-title">
        <span class="title-arabic">Ø§Ù„Ù‚ÙØ¨Ù’Ù„ÙØ©</span>
        <span class="title-uzbek" data-i18n="qibla.title">Qibla Yo'nalishi</span>
      </h2>
    </div>

    <!-- STATUS STATES CONTAINER -->
    <div class="states-container">
      
      <!-- Loading State -->
      <div class="state-card loading-state" id="loadingState">
        <div class="loader">
          <div class="loader-ring"></div>
          <div class="loader-ring"></div>
          <div class="loader-ring"></div>
          <span class="loader-icon">ğŸ§­</span>
        </div>
        <p class="state-title" data-i18n="qibla.compassPreparing">Kompas tayyorlanmoqda...</p>
        <p class="state-hint" data-i18n="qibla.holdFlat">Qurilmangizni tekis ushlang</p>
      </div>

      <!-- Permission State -->
      <div class="state-card permission-state" id="permissionState" style="display: none;">
        <div class="permission-icon-wrapper">
          <span class="permission-icon">ğŸ“±</span>
          <span class="permission-badge">ğŸ§­</span>
        </div>
        <h3 class="state-title" data-i18n="qibla.permissionNeeded">Kompas ruxsati kerak</h3>
        <p class="state-description" data-i18n="qibla.permissionDesc">
          Qibla yo'nalishini aniqlash uchun qurilmangizning kompas funksiyasidan foydalanishga ruxsat bering.
        </p>
        <button class="action-btn primary" id="requestPermissionBtn">
          <span class="btn-icon">âœ“</span>
          <span class="btn-text" data-i18n="qibla.grantPermission">Ruxsat berish</span>
        </button>
        <p class="state-note">
          <span class="note-icon">ğŸ’¡</span>
          <span data-i18n="qibla.safariNote">Safari so'roviga "Allow" tugmasini bosing</span>
        </p>
      </div>

      <!-- Error State -->
      <div class="state-card error-state" id="errorState" style="display: none;">
        <div class="error-icon-wrapper">
          <span class="error-icon">âš ï¸</span>
        </div>
        <h3 class="state-title error-title" data-i18n="qibla.error">Xatolik yuz berdi</h3>
        <p class="state-description" id="errorMessage" data-i18n="qibla.errorDesc">
          Kompasga ulanib bo'lmadi. Qurilma sozlamalarini tekshiring.
        </p>
        <button class="action-btn secondary" id="retryBtn">
          <span class="btn-icon">ğŸ”„</span>
          <span class="btn-text" data-i18n="qibla.retry">Qaytadan urinish</span>
        </button>
      </div>

      <!-- Calibration State (MANDATORY) -->
      <div class="state-card calibration-state" id="calibrationState" style="display: none;">
        <div class="calibration-visual">
          <div class="figure-eight-container">
            <div class="figure-eight-path"></div>
            <div class="phone-demo">
              <span class="phone-icon">ğŸ“±</span>
            </div>
          </div>
        </div>
        <h3 class="state-title" data-i18n="qibla.calibrateTitle">Kompasni kalibratsiya qiling</h3>
        <p class="state-description" data-i18n="qibla.calibrateDesc">
          Aniq natija olish uchun telefonni havoda <strong>âˆ (cheksizlik)</strong> belgisi shaklida bir necha marta harakatlantiring.
        </p>
        <div class="calibration-steps">
          <div class="cal-step">
            <span class="step-num">1</span>
            <span class="step-text" data-i18n="qibla.calibrateStep1">Telefonni âˆ shaklida harakatlantiring</span>
          </div>
          <div class="cal-step">
            <span class="step-num">2</span>
            <span class="step-text" data-i18n="qibla.calibrateStep2">5-6 marta takrorlang</span>
          </div>
        </div>
        <div class="calibration-progress" id="calibrationProgress">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <span class="progress-text" id="progressText" data-i18n="qibla.calibrating">Kalibratsiya qiling...</span>
        </div>
      </div>

    </div>

    <!-- MAIN COMPASS DISPLAY -->
    <div class="compass-display" id="compassDisplay" style="display: none;">
      
      <!-- ========== TOP SECTION: Turn Instruction (MOST IMPORTANT) ========== -->
      <div class="turn-instruction-top" id="alignmentStatus">
        <div class="status-indicator" id="statusIndicator">
          <span class="status-emoji">ğŸ§­</span>
        </div>
        <div class="instruction-content">
          <p class="status-message" id="statusMessage" data-i18n="qibla.turnDevice">Qurilmani aylantiring...</p>
          <div class="turn-info">
            <span class="turn-indicator" id="turnDirection">â†»</span>
            <span class="turn-degrees"><span id="differenceAngle">--</span>Â° <span data-i18n="qibla.remaining">qoldi</span></span>
          </div>
        </div>
      </div>

      <!-- Qibla Angle Card (Important - at top) -->
      <div class="qibla-angle-card-top">
        <div class="angle-item">
          <span class="angle-icon">ğŸ•‹</span>
          <div class="angle-info">
            <span class="angle-label" data-i18n="qibla.qiblaAngle">Qibla burchagi</span>
            <span class="angle-value" id="qiblaAngleValue">--Â°</span>
          </div>
        </div>
        <div class="angle-divider"></div>
        <div class="angle-item">
          <span class="angle-icon">ğŸ§­</span>
          <div class="angle-info">
            <span class="angle-label" data-i18n="qibla.yourDirection">Siz qaragan yo'nalish</span>
            <span class="angle-value" id="headingAngleValueTop">--Â°</span>
          </div>
        </div>
      </div>

      <!-- Main Compass -->
      <div class="compass-main">
        
        <!-- Compass Background -->
        <div class="compass-bg">
          <div class="compass-outer-ring"></div>
          <div class="compass-inner-ring"></div>
        </div>

        <!-- Compass Rose (rotates with device) -->
        <div class="compass-rose" id="compassRose">
          <!-- Cardinal directions -->
          <div class="cardinal north">
            <span class="cardinal-letter">N</span>
            <span class="cardinal-name" data-i18n="qibla.north">Shimol</span>
          </div>
          <div class="cardinal east">
            <span class="cardinal-letter">E</span>
            <span class="cardinal-name" data-i18n="qibla.east">Sharq</span>
          </div>
          <div class="cardinal south">
            <span class="cardinal-letter">S</span>
            <span class="cardinal-name" data-i18n="qibla.south">Janub</span>
          </div>
          <div class="cardinal west">
            <span class="cardinal-letter">W</span>
            <span class="cardinal-name" data-i18n="qibla.west">G'arb</span>
          </div>
          
          <!-- Degree ticks -->
          <div class="degree-ticks"></div>
        </div>

        <!-- Qibla Pointer (shows direction to turn) -->
        <div class="qibla-pointer" id="qiblaPointer">
          <div class="pointer-arrow">
            <div class="arrow-tip"></div>
            <div class="arrow-shaft"></div>
          </div>
          <div class="kaaba-marker">
            <span class="kaaba-icon">ğŸ•‹</span>
          </div>
          <span class="qibla-label">QIBLA</span>
        </div>

        <!-- Center Hub with DYNAMIC HEADING -->
        <div class="compass-center">
          <div class="center-circle">
            <div class="heading-display">
              <span class="heading-value" id="headingAngleValue">--Â°</span>
              <span class="heading-label" data-i18n="qibla.direction">Yo'nalish</span>
            </div>
          </div>
        </div>

        <!-- Device Direction Indicator (always points up) -->
        <div class="device-indicator" id="devicePointer">
          <div class="device-arrow"></div>
        </div>

      </div>

      <!-- ========== BOTTOM SECTION: Secondary Info ========== -->
      
      <!-- Location & Distance Info (Less important - at bottom) -->
      <div class="secondary-info-row">
        <div class="secondary-info-card">
          <span class="sec-info-icon">ğŸ“</span>
          <div class="sec-info-content">
            <span class="sec-info-label" data-i18n="qibla.location">Joylashuv</span>
            <span class="sec-info-value" id="locationValue">--</span>
          </div>
        </div>
        <div class="secondary-info-card">
          <span class="sec-info-icon">ğŸ•‹</span>
          <div class="sec-info-content">
            <span class="sec-info-label" data-i18n="qibla.distanceToMakkah">Makkagacha</span>
            <span class="sec-info-value" id="distanceValue">-- km</span>
          </div>
        </div>
      </div>

      <!-- Quality Indicator (Least important - at very bottom) -->
      <div class="quality-bar" id="compassQuality">
        <span class="quality-label" data-i18n="qibla.compassSignal">Kompas signali:</span>
        <div class="quality-dots">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
        <span class="quality-text" id="qualityText">--</span>
      </div>

      <!-- Recalibrate Button -->
      <button class="recalibrate-btn" id="recalibrateBtn">
        <span class="btn-icon">ğŸ”„</span>
        <span class="btn-text" data-i18n="qibla.recalibrate">Qayta kalibratsiya</span>
      </button>

      <!-- Tips Section -->
      <div class="tips-section">
        <div class="tips-header">
          <span class="tips-icon">ğŸ’¡</span>
          <span class="tips-title" data-i18n="qibla.tipsTitle">Aniqroq natija uchun</span>
        </div>
        <ul class="tips-list">
          <li data-i18n="qibla.tip1">Telefonni gorizontal (tekis) ushlang</li>
          <li data-i18n="qibla.tip2">Metall buyumlardan uzoqroq turing</li>
          <li data-i18n="qibla.tip3">Elektron qurilmalardan uzoqlashing</li>
          <li data-i18n="qibla.tip4">Ochiq maydonlarda ishlating</li>
        </ul>
      </div>

    </div>

  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="../../js/i18n.js"></script>
  <script src="../../js/locationManager.js"></script>
  <script src="qibla.js"></script>

</body>
</html>
